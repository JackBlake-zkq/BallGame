<!DOCTYPE html>
<html>

<head>
    <title>Ball Shot</title>
    <style>
        :root{

        }
        html{

        }
        body{
            
        }
        svg {
            width:50%;
            height:50%;
            margin-left:25%;
            background: lightgray;
        }
        .levelCard{
            border: 5px solid black;
            margin: 20px;
            padding: 20px;
        }
    </style>
</head>

<body>

    <section id="registerSection">
        <form id="registerForm">
            <h1>Register</h1>
            <label for="email">Email</label>
            <input type=text id="registerEmail" name="email">
            <label for="username">Username</label>
            <input type=text id="registerUsername" name="username">
            <label for="password">Password</label>
            <input type=text id="registerPassword" namne="password">
            <input type="submit">
        </form>
    </section>

    <section id="loginSection">
        <h1>Login</h1>
        <form id="loginForm">
            <label for="email">Email</label>
            <input type=text id="loginEmail" name="email">
            <label for="password">Password</label>
            <input type=text id="loginPassword" name=password>
            <input type="submit">
        </form>
        <p>Don't have an account?</p>
        <button id="registerButton">Register</button>
    </section>

    <section id="codeSection">
        <form id="codeForm">
            <h1>Confirmation Code</h1>
            <input type=text id="code" name="code">
            <input type="submit">
        </form>
    </section>

    <section id="menuSection">
        <div id="levels">

        </div>
        <button id="createLevelButton">Create Level</button>
        <button id="myLevelsButton">My Levels</button>
    </section>

    <section id="createLevelSection">
        <label for="name">Level Name</label>
        <input type="text" name="name" id="createLevelName">
        <label for="bounces">Maximum Bounces</label>
        <input type="text" name="bounces" id="createLevelBounces">
        <div id="toolSelect">
            <button id="selectLineTool">Wall</button>
            <button id="selectGoalTool">Goal</button>
            <button id="selectStartTool">Start Point</button>
        </div>
        <svg id="svg2" viewBox="0 0 100 100"></svg>
        <button id="submitLevel">Upload Level</button>
        <button class="menuButton">Back</button>
    </section>

    <section id="levelPlaySection">
        <h3 id="maxBounces"></h3>
        <svg id="svg" viewBox="0 0 100 100"></svg>
        <h4 id="winStatus"></h4>
        <button class="menuButton">Back</button>
    </section>

    <section id="leaderboardSection">
        <h1>Leaderboard</h1>
        <div id="levelLeaderboard"></div>
        <button class="menuButton">Back</button>
    </section>

    <section id="myLevelsSection">
        <div id="myLevels">

        </div>
        <button class="menuButton">Back</button>
    </section>



    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/snap.svg/0.5.1/snap.svg-min.js" integrity="sha512-Gk+uNk8NWN235mIkS6B7/424TsDuPDaoAsUekJCKTWLKP6wlaPv+PBGfO7dbvZeibVPGW+mYidz0vL0XaWwz4w==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script>
        const socket = io();
        const $ = id => document.getElementById(id);
        const s = Snap('#svg');
        const s2 = Snap('#svg2');

        clearSections();


        //authentication event listeners and emition
        let currEmail = '';

        $('registerForm').onsubmit = e => {
            e.preventDefault();
            currEmail = $('registerEmail').value;
            socket.emit('register', {
                email: currEmail,
                username: $('registerUsername').value,
                password: $('registerPassword').value
            });
        }
        $('loginForm').onsubmit = e => {
            e.preventDefault();
            currEmail = $('loginEmail').value;
            socket.emit('loginAttempt', {
                email: currEmail,
                password: $('loginPassword').value
            });
        }
        $('codeForm').onsubmit = e => {
            e.preventDefault();
            socket.emit('codeAttempt', {
                email: currEmail,
                code: $('code').value
            });
        }

        //authenitication navigation
        $('registerButton').onclick = e => {
            clearSections();
            $('registerSection').style.display = '';
        }
        socket.on('codePrompt', () => {
            clearSections();
            $('codeSection').style.display = '';
        });
        socket.on('loginPrompt', () => {
            clearSections();
            $('loginSection').style.display = '';
        });

        //Problems during authentication
        socket.on('failedEmail', () => {
            alert('Failed Confirmation Email');
        });
        socket.on('emailTaken', () => {
            alert('Email Taken');
        });
        socket.on('wrongCode', () => {
            alert('Wrong Code');
        });
        socket.on('emailNotFound', () => {
            alert('Email Not Found');
        });
        socket.on('wrongPassword', () => {
            alert('Wrong Password');
        });


        //data getters

        async function getDisplayInfo() {
            return new Promise((resolve, reject) => {
                socket.emit('getDisplayInfo');
                socket.on('displayInfo', data => {
                    resolve(data);
                });
                socket.on('notAuthenticated', () => {
                    reject('Not Authenticated')
                });
                setTimeout(() => reject('Timed out'), 5000);
            });
        }

        async function getLevelData(name) {
            return new Promise((resolve, reject) => {
                socket.emit('getLevelData', name);
                socket.on('levelData', data => {
                    resolve(data);
                });
                socket.on('notAuthenticated', () => {
                    reject('Not Authenticated')
                });
                socket.on('levelDNE', () => {
                    reject('Level does not exist');
                })
                setTimeout(() => reject('Timed out'), 5000);
            });
        }

        async function getInstructions(name) {
            let v = {
                x: $('targetLine').getAttribute('x2') - $('targetLine').getAttribute('x1'),
                y: -($('targetLine').getAttribute('y2') - $('targetLine').getAttribute('y1'))
            };
            let magV = Math.sqrt(v.x * v.x + v.y * v.y);
            let angleV = Math.acos(v.x / magV) * (180 / Math.PI);
            if (v.y < 0) angleV = 360 - angleV;
            return new Promise((resolve, reject) => {
                let instructions = null;
                socket.emit('playLevel', {
                    name: name,
                    angle: angleV
                });
                let info = {
                    isPB: false,
                    clear: false
                };
                socket.on('newPB', () => {
                    info.isPB = true;
                });
                socket.on('animateClear', instructions => {
                    info.clear = true;
                    info.instructions = instructions;
                    resolve(info);
                });
                socket.on('animateFail', instructions => {
                    info.instructions = instructions;
                    resolve(info);
                });
                socket.on('notAuthenticated', () => {
                    reject('Not Authenticated')
                });
                socket.on('badData', () => {
                    reject('Bad Data');
                });
                socket.on('levelDNE', () => {
                    reject('Level does not exist')
                });
                socket.on('ownLevel', () => {
                    reject('You cannot play your own level after verifying!')
                });
                setTimeout(() => reject('Timed out'), 5000);
            });
        }

        async function getMyLevels(){
            return new Promise( (resolve, reject) => {
                socket.emit('getMyLevels');
                socket.on('notAuthenticated', () => {
                    reject('You must login to do that!');
                });
                socket.on('myLevels', levels => {
                    resolve(levels);
                });
                setTimeout(() => reject('Timed out'), 5000);
            })
        }

        async function getLeaderboard(name){
            return new Promise( (resolve, reject) => {
                socket.emit('getLeaderboard', name);
                socket.on('notAuthenticated', () => {
                    reject('Not Authenticated');
                });
                socket.on('levelDNE', () => {
                    reject('Level does not exist');
                });
                socket.on('leaderboard', leaderboard => {
                    resolve(leaderboard);
                });
                setTimeout(() => reject('Timed out'), 5000);
            });
        }

        //section display functions

        function displayMenu(){
            getDisplayInfo()
                .then(data => {

                    clearSections();
                    $('menuSection').style.display = ''
                    clearChildren('levels');

                    data.forEach(item => {
                        let div = document.createElement('div');
                        div.className = 'levelCard';

                        let text = document.createElement('h2');
                        text.textContent = item.name;
                        div.appendChild(text);

                        let playButton = document.createElement('button');
                        playButton.textContent = 'play';
                        div.appendChild(playButton);
                        playButton.onclick = e => {
                            displayLevel(item.name);
                        }

                        let leaderboardButton = document.createElement('button');
                        leaderboardButton.textContent = 'leaderboard'
                        div.appendChild(leaderboardButton);
                        leaderboardButton.onclick = e => {
                            displayLeaderboard(item.name);
                        }

                        $('levels').appendChild(div);
                    });
                })
                .catch(error => alert(error));
        }

        function displayLevel(name) {
            getLevelData(name)
            .then( data => {

                clearSections();
                $('levelPlaySection').style.display = '';

                $('svg').removeEventListener('mousemove', levelPlayMouseMoveHandler);
                $('svg').removeEventListener('click', levelPlayClickHandler);

                clearChildren('svg');

                $('maxBounces').textContent = `Maximum Bounces: ${data.bounces}`;

                for (let [key, value] of Object.entries(data.lines)) {
                    createLine({
                        p1: cartesianToViewBox(value.p1),
                        p2: cartesianToViewBox(value.p2)
                    }, 'black', 1, s);
                }
                createLine({
                    p1: cartesianToViewBox(data.goal.p1),
                    p2: cartesianToViewBox(data.goal.p2)
                }, 'green', 2, s);
                createCircle(cartesianToViewBox(data.start), 'blue', 2, s);
                $('svg').addEventListener('mousemove', levelPlayMouseMoveHandler);
                $('svg').addEventListener('click', levelPlayClickHandler);

                function levelPlayClickHandler(e){
                    $('winStatus').textContent = '';
                    getInstructions(name)
                        .then(info => {
                            let ball = createCircle(cartesianToViewBox(info.instructions[0]), 'red', 1, s);
                            animate(info.instructions, ball, 0);

                            if(info.clear){
                                if(info.isPB){
                                    $('winStatus').textContent = `New Personal Best! ${info.instructions.length - 2} bounces`;
                                } else {
                                    $('winStatus').textContent = `Not a personal best... ${info.instructions.length - 2} bounces`;
                                }
                            } else {
                                $('winStatus').textContent = 'Fail';
                            }
                            //display some stuff based on if you beat it
                        })
                        .catch(error => alert(error));
                }
                function levelPlayMouseMoveHandler(e){
                    if ($('targetLine')) $('targetLine').remove();
                    let point = $('svg').createSVGPoint();
                    point.x = e.clientX;
                    point.y = e.clientY;
                    point = point.matrixTransform($('svg').getScreenCTM().inverse());
                    let targetLine = createLine({
                        p1: cartesianToViewBox(data.start),
                        p2: point
                    }, 'lightblue', 1, s);
                    targetLine.attr({
                        id: 'targetLine'
                    });
                }
            })
            .catch( error => alert(error) );
            
        }

        function displayLeaderboard(name){
            getLeaderboard(name)
            .then( array => {

                clearSections();
                $('leaderboardSection').style.display = '';
                clearChildren('levelLeaderboard');

                array.forEach(item => {
                    let elem = document.createElement('div');
                    elem.textContent = `${item.username}: ${item.bounces}`;
                    $('levelLeaderboard').appendChild(elem);
                });
            })
            .catch( error => alert(error) );
        }

        function displayMyLevels(){
            clearSections();
            clearChildren('myLevels');
            $('myLevelsSection').style.display = '';
            getMyLevels()
            .then( levels => {
                for(let level of levels){
                    let div = document.createElement('div');
                    div.className = 'levelCard';

                    let text = document.createElement('h2');
                    text.textContent = level.name;
                    div.appendChild(text);

                    if(level.status == 'verified'){
                        let leaderboardButton = document.createElement('button');
                        leaderboardButton.textContent = 'leaderboard'
                        div.appendChild(leaderboardButton);
                        leaderboardButton.onclick = e => {
                            displayLeaderboard(level.name);
                        }
                    } else {
                        let verifyButton = document.createElement('button');
                        verifyButton.textContent = 'verify';
                        div.appendChild(verifyButton);
                        verifyButton.onclick = e => {
                            displayLevel(level.name);
                        }
                    }
                    $('myLevels').appendChild(div);
                }
            })
            .catch( error => alert(error));
        }

        //event listeners

        socket.on('authenticated', displayMenu);

        for(let elem of Array.from(document.getElementsByClassName('menuButton'))) {
            elem.onclick = displayMenu;
        }

        let currLevelObj = null;
        let lineCount = 0;
        $('createLevelButton').onclick = e => {
            clearSections();
            $('createLevelSection').style.display = '';
            clearChildren('svg2');
            currLevelObj = {};
            lineCount = 0;
        }

        let currTool = 'line';

        $('selectLineTool').onclick = e => {
            currTool = 'line';
        }
        $('selectGoalTool').onclick = e => {
            currTool = 'goal';
        }
        $('selectStartTool').onclick = e => {
            currTool = 'start';
        }
            
        let lastLinePoint = null;
        let lastGoalPoint = null;
        $('svg2').onclick = e => {
            let point = $('svg2').createSVGPoint();
            point.x = e.clientX;
            point.y = e.clientY;
            point = point.matrixTransform($('svg2').getScreenCTM().inverse());
            if(currTool == 'start'){
                if(currLevelObj.start) {
                    alert('You already placed a start point');
                } else {
                    createCircle(point, 'blue', 2, s2);
                    currLevelObj.start = viewBoxToCartesian(point);
                }
            } else if(currTool == 'line'){
                createCircle(point, 'black', 0.5, s2);
                if(lastLinePoint == null){
                    lastLinePoint = point;
                } else {
                    let l = {
                        p1:lastLinePoint,
                        p2:point
                    }
                    if(currLevelObj.lines == null) currLevelObj.lines = {};
                    currLevelObj.lines[`line${lineCount++}`] = {
                        p1: viewBoxToCartesian(l.p1),
                        p2: viewBoxToCartesian(l.p2)
                    }
                    createLine(l, 'black', 1, s2);
                    lastLinePoint = null;
                }
            } else if(currTool == 'goal'){
                if(currLevelObj.goal){
                    alert('you already made a goal');
                    return;
                }
                createCircle(point, 'green', 1, s2);
                if(lastGoalPoint == null){
                    lastGoalPoint = point;
                } else {
                    let l = {
                        p1:lastGoalPoint,
                        p2:point
                    }
                    currLevelObj.goal = {
                        p1: viewBoxToCartesian(l.p1),
                        p2: viewBoxToCartesian(l.p2)
                    }
                    createLine(l, 'green', 2, s2);
                    lastGoalPoint = null
                }
            } else {
                alert('No tool selected!');
            }
        }

        $('submitLevel').onclick = e => {
            new Promise( (resolve, reject) => {
                socket.emit('newLevel', {
                    lines: currLevelObj.lines,
                    goal: currLevelObj.goal,
                    start: currLevelObj.start,
                    name: $('createLevelName').value,
                    bounces: +$('createLevelBounces').value
                });
                socket.on('notAuthenticated', () => {
                    reject('Not Authenticated');
                });
                socket.on('badData', () => {
                    reject("There's something wrong with your level");
                });
                socket.on('nameTaken', () => {
                    reject('Choose a different name for your level');
                });
                socket.on('levelCreated', name => {
                    resolve();
                });
            })
            .then( () => {
                displayMyLevels();
            })
            .catch( error => alert(error) );
        }

        $('myLevelsButton').onclick = displayMyLevels;

        

        //utility functions
        function clearChildren(id){
            for(let child of Array.from($(id).children)){
                child.remove();
            }
        }

        function clearSections() {
            Array.from(document.querySelectorAll('section')).forEach(item => {
                item.style.display = 'none';
            });
        }

        function viewBoxToCartesian(point) {
            return {
                x: point.x - 50,
                y: 50 - point.y
            }
        }
        function cartesianToViewBox(point) {
            return {
                x: point.x + 50,
                y: -point.y + 50
            }
        }
        function distance(p1, p2) {
            return Math.sqrt(
                (p2.y - p1.y) * (p2.y - p1.y) +
                (p2.x - p1.x) * (p2.x - p1.x)
            );
        }

        function createLine(line, color, thickness, snap) {
            let snapLine = snap.line(line.p1.x, line.p1.y, line.p2.x, line.p2.y);
            snapLine.attr({
                stroke: color,
                strokeWidth: thickness
            });
            return snapLine;
        }
        function createCircle(point, color, radius, snap) {
            let snapCircle = snap.circle(point.x, point.y, radius);
            snapCircle.attr({
                fill: color,
                stroke: color
            });
            return snapCircle;
        }
        function animate(instructions, ball, index){
            if(index > instructions.length - 2){
                ball.remove();
                return;
            }
            const speed = 50; //50 units/second
            let time = (distance(instructions[index], instructions[index + 1]) / speed) * 1000;
            ball.animate({
                cx: cartesianToViewBox(instructions[index + 1]).x,
                cy: cartesianToViewBox(instructions[index + 1]).y
            }, time);
            setTimeout( () => animate(instructions, ball, index + 1), time );
        }


    </script>
</body>

</html>